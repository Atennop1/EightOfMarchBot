using EightOfMarchBot.Core;
using EightOfMarchBot.Loop;
using Telegram.BotAPI;
using Telegram.BotAPI.GettingUpdates;

namespace EightOfMarchBot
{
    public sealed class Game
    {
        private IMessageSender _messageSender;
        private GameLoop _gameLoop;
        
        public void Play()
        {
            var client = new BotClient("your bot token");
            _messageSender = new MessageSender(client);
            
            var gameStart = new GameStart(_messageSender);
            var gameEnd = new GameEnd(_messageSender);

            var questions = new List<IQuestion>
            {
                new Question("Вопрос 1", "Ответ 1"),
                new Question("Вопрос 2", "Ответ 2")
            };

            var questionsCycle = new QuestionsCycle(questions, _messageSender);
            _gameLoop = new GameLoop(questionsCycle, gameStart, gameEnd);

            StartUpdatingCycle(client);
        }

        private void StartUpdatingCycle(BotClient client)
        {
            var updates = client.GetUpdates();

            while (true)
            {
                if (!updates.Any())
                {
                    updates = client.GetUpdates();
                    continue;
                }
                
                foreach (var update in updates)
                {
                    if (update.Message == null || update.Message.Text == null)
                        continue;

                    _messageSender.ChangeChat(update.Message.Chat.Id.ToString());
            
                    if (update.Message.Text == "/start")
                    {
                        _gameLoop.Start();
                        continue;
                    }
            
                    _gameLoop.Continue(update.Message.Text);
                }

                var offset = updates.Last().UpdateId + 1;
                updates = client.GetUpdates(offset, limit: 10, timeout: 60);
            }
        }
    }
}